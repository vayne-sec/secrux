services:
  secrux-server:
    image: ${SECRUX_SERVER_IMAGE:-secrux-server:latest}
    restart: unless-stopped
    ports:
      - "${SECRUX_SERVER_PORT:-8080}:8080"
      - "${EXECUTOR_GATEWAY_PORT:-5155}:5155"
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL:?set SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME:?set SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD:?set SPRING_DATASOURCE_PASSWORD}

      SECRUX_KAFKA_BOOTSTRAP_SERVERS: ${SECRUX_KAFKA_BOOTSTRAP_SERVERS:?set SECRUX_KAFKA_BOOTSTRAP_SERVERS}

      SECRUX_AUTH_MODE: ${SECRUX_AUTH_MODE:-KEYCLOAK}
      SECRUX_AUTH_ISSUER_URI: ${SECRUX_AUTH_ISSUER_URI:?set SECRUX_AUTH_ISSUER_URI}
      SECRUX_AUTH_AUDIENCE: ${SECRUX_AUTH_AUDIENCE:-secrux-api}

      SECRUX_KEYCLOAK_ADMIN_ENABLED: ${SECRUX_KEYCLOAK_ADMIN_ENABLED:-true}
      SECRUX_KEYCLOAK_ADMIN_BASE_URL: ${SECRUX_KEYCLOAK_ADMIN_BASE_URL:?set SECRUX_KEYCLOAK_ADMIN_BASE_URL}
      SECRUX_KEYCLOAK_ADMIN_REALM: ${SECRUX_KEYCLOAK_ADMIN_REALM:-secrux}
      SECRUX_KEYCLOAK_ADMIN_CLIENT_ID: ${SECRUX_KEYCLOAK_ADMIN_CLIENT_ID:-secrux-admin}
      SECRUX_KEYCLOAK_ADMIN_CLIENT_SECRET: ${SECRUX_KEYCLOAK_ADMIN_CLIENT_SECRET:-changeme}

      SECRUX_CRYPTO_SECRET: ${SECRUX_CRYPTO_SECRET:?set SECRUX_CRYPTO_SECRET}

      SECRUX_EXECUTOR_API_BASE_URL: ${SECRUX_EXECUTOR_API_BASE_URL:?set SECRUX_EXECUTOR_API_BASE_URL}

      SECRUX_AI_DB_URL: ${SECRUX_AI_DB_URL:?set SECRUX_AI_DB_URL}
      SECRUX_AI_DB_USERNAME: ${SECRUX_AI_DB_USERNAME:?set SECRUX_AI_DB_USERNAME}
      SECRUX_AI_DB_PASSWORD: ${SECRUX_AI_DB_PASSWORD:?set SECRUX_AI_DB_PASSWORD}

      SECRUX_AI_SERVICE_BASE_URL: ${SECRUX_AI_SERVICE_BASE_URL:-http://ai-service:5156}
      SECRUX_AI_SERVICE_TOKEN: ${SECRUX_AI_SERVICE_TOKEN:?set SECRUX_AI_SERVICE_TOKEN}

      EXECUTOR_GATEWAY_ENABLED: ${EXECUTOR_GATEWAY_ENABLED:-true}
      EXECUTOR_GATEWAY_PORT: ${EXECUTOR_GATEWAY_PORT:-5155}
      EXECUTOR_GATEWAY_CERTIFICATE_PATH: ${EXECUTOR_GATEWAY_CERTIFICATE_PATH:-/certs/executor-gateway/gateway.crt}
      EXECUTOR_GATEWAY_PRIVATE_KEY_PATH: ${EXECUTOR_GATEWAY_PRIVATE_KEY_PATH:-/certs/executor-gateway/gateway.key}
    volumes:
      - server_uploads:/app/build/uploads
      - server_workspaces:/app/build/workspaces
      # Optional: mount TLS certs for Executor Gateway (generate with the repo-root script and copy here)
      - ./certs/executor-gateway:/certs/executor-gateway:ro

  ai-service:
    image: ${SECRUX_AI_IMAGE:-secrux-ai:latest}
    restart: unless-stopped
    ports:
      - "${AI_PORT:-5156}:5156"
    environment:
      SECRUX_AI_SERVICE_TOKEN: ${SECRUX_AI_SERVICE_TOKEN:?set SECRUX_AI_SERVICE_TOKEN}
      AI_DATABASE_URL: ${AI_DATABASE_URL:?set AI_DATABASE_URL}
      SECRUX_AI_LLM_BASE_URL: ${SECRUX_AI_LLM_BASE_URL:-}
      SECRUX_AI_LLM_API_KEY: ${SECRUX_AI_LLM_API_KEY:-}
      SECRUX_AI_LLM_MODEL: ${SECRUX_AI_LLM_MODEL:-}
      SECRUX_AI_PROMPT_DUMP: ${SECRUX_AI_PROMPT_DUMP:-off}
      SECRUX_AI_PROMPT_DUMP_DIR: ${SECRUX_AI_PROMPT_DUMP_DIR:-/app/storage/prompt-dumps}
      SECRUX_AI_PROMPT_DUMP_FILE_STRATEGY: ${SECRUX_AI_PROMPT_DUMP_FILE_STRATEGY:-target}
      SECRUX_AI_PROMPT_DUMP_FILTER_PURPOSE: ${SECRUX_AI_PROMPT_DUMP_FILTER_PURPOSE:-review}
      SECRUX_AI_PROMPT_DUMP_FILTER_JOB_ID: ${SECRUX_AI_PROMPT_DUMP_FILTER_JOB_ID:-}
      SECRUX_AI_PROMPT_DUMP_FILTER_TARGET_ID: ${SECRUX_AI_PROMPT_DUMP_FILTER_TARGET_ID:-}
      SECRUX_AI_PROMPT_DUMP_FILTER_AGENT: ${SECRUX_AI_PROMPT_DUMP_FILTER_AGENT:-}
      SECRUX_AI_PROMPT_DUMP_FILTER_MODE: ${SECRUX_AI_PROMPT_DUMP_FILTER_MODE:-}
      SECRUX_AI_PROMPT_DUMP_INCLUDE_RESPONSE: ${SECRUX_AI_PROMPT_DUMP_INCLUDE_RESPONSE:-false}
      SECRUX_AI_PROMPT_DUMP_INCLUDE_FINDING: ${SECRUX_AI_PROMPT_DUMP_INCLUDE_FINDING:-false}
      SECRUX_AI_PROMPT_DUMP_INCLUDE_ENRICHMENT: ${SECRUX_AI_PROMPT_DUMP_INCLUDE_ENRICHMENT:-false}
      SECRUX_AI_PROMPT_DUMP_MAX_CHARS: ${SECRUX_AI_PROMPT_DUMP_MAX_CHARS:-200000}
    volumes:
      - ai_mcp_data:/app/storage/mcps
      - ai_agent_data:/app/storage/agents
      - ai_prompt_dumps:/app/storage/prompt-dumps

  secrux-console:
    image: ${SECRUX_CONSOLE_IMAGE:-secrux-console:latest}
    restart: unless-stopped
    ports:
      - "${CONSOLE_PORT:-80}:80"
    environment:
      SECRUX_API_BASE_URL: ${SECRUX_API_BASE_URL:?set SECRUX_API_BASE_URL}
      SECRUX_AUTH_MODE_UI: ${SECRUX_AUTH_MODE_UI:-keycloak}
      SECRUX_OIDC_BASE_URL: ${SECRUX_OIDC_BASE_URL:?set SECRUX_OIDC_BASE_URL}
      SECRUX_OIDC_REALM: ${SECRUX_OIDC_REALM:-secrux}
      SECRUX_OIDC_CLIENT_ID: ${SECRUX_OIDC_CLIENT_ID:-secrux-console}
      SECRUX_OIDC_SCOPE: ${SECRUX_OIDC_SCOPE:-openid}
      SECRUX_APP_VERSION: ${SECRUX_APP_VERSION:-prod}
    depends_on:
      - secrux-server

volumes:
  server_uploads:
  server_workspaces:
  ai_mcp_data:
  ai_agent_data:
  ai_prompt_dumps:
